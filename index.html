<head>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>



<body>
    <audio id="a1" controls autoplay></audio>
    <audio id="a2" controls autoplay></audio>
    <script>
        //@ts-check

        const offerOptions = {
            offerToReceiveAudio: 1,
            offerToReceiveVideo: 1
        };

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function foo(pc2, stream) {
            pc2.addTransceiver(stream.getAudioTracks()[0])
        }

        async function xxx() {





            console.log(999)

            const gumopts = { video: { width: 1280, height: 720 }, audio: true }
            const stream = await navigator.mediaDevices.getUserMedia(gumopts)



            // SFU downstream
            let downstream = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] })
            downstream.ontrack = async event => console.debug('downstream: **TRACK callback')
            downstream.onconnectionstatechange = e => console.log('pc1:' + downstream.connectionState)
    
            //pc1.addTransceiver('video')
            // pc1.addTransceiver('audio')

            /*
            The browser only needs two transcievers: one for audio and one for video

            A downstream SFU connecting may need lots of transcievers: 100x video, 10x audio


            */
            
            
            //console.debug('downstream lines', downstream.localDescription.sdp.split(/\r\n|\r|\n/).length)

            //console.log((await downstream.createOffer()).sdp)
            downstream.addTransceiver('video', { 'direction': 'recvonly' })
            //downstream.addTransceiver('video', { 'direction': 'recvonly' })
            //downstream.addTransceiver('video', { 'direction': 'recvonly' })
           // console.log((await downstream.createOffer()).sdp)

           // console.debug('downstream lines', downstream.localDescription.sdp.split(/\r\n|\r|\n/).length)
            downstream.addTransceiver('audio', { 'direction': 'recvonly' })

            
            let upstream = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] })
            upstream.onconnectionstatechange = e => console.log('pc2:' + upstream.connectionState)
            upstream.ontrack = async event => { console.debug('upstream: **TRACK callback') }
            
            upstream.addTrack(stream.getVideoTracks()[0])
           
                upstream.addTrack(stream.getAudioTracks()[0])
           
            
            //upstream.addTransceiver('video', { 'direction': 'sendonly' })              
            //  upstream.addTransceiver('video', { 'direction': 'sendonly' })
            //upstream.addTransceiver('video', { 'direction': 'sendonly' })
            
            




            downstream.onicecandidate = function (e) {
                if (e.candidate) { upstream.addIceCandidate(e.candidate) }
                return false
            }

            upstream.onicecandidate = function (e) {
                if (e.candidate) { downstream.addIceCandidate(e.candidate) }
                return false
            }



            
           


            const offer = await downstream.createOffer()
       
            await downstream.setLocalDescription(offer)

            //network

            await upstream.setRemoteDescription(offer)
            const answer = await upstream.createAnswer()
            console.debug('upstream ans nlines', answer.sdp.split(/\r\n|\r|\n/).length)
            await upstream.setLocalDescription(answer)

            //network
            

            await downstream.setRemoteDescription(answer)
          
            upstream.addTransceiver(stream.getAudioTracks()[0])
            



            // const offer = await pc2.createOffer()
            // await pc2.setLocalDescription(offer)
            // //network
            // await pc1.setRemoteDescription(offer)
            // const answer = await pc1.createAnswer()
            // await pc1.setLocalDescription(answer)
            // //network
            // await pc2.setRemoteDescription(answer)




            console.log('end end end')
        }

        xxx()

    </script>
</body>